<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script src="http://code.jquery.com/jquery-latest.js"></script> 
    <title>주소로 장소 표시하기</title>
    <style>
    html, body { height: 100%;}
    input { line-height: 50px;}
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f1b6ed2e1d208736a93f48c704aa9498&libraries=services"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $("#info").load("./info.html");
        });
    </script>
</head>

<body>
    <div class="search" style="text-align: center; padding-bottom: 20px;">
        <input id="address" type="text" placeholder="검색할 주소" value="" size="30" style="line-height: 30px; font-size: 20px;"/>
        <input id="submit" type="button" value="주소 검색" style="height: 30px; font-size:20px;"/>
    </div>
    <div id="map" style="width:100%;height:60%; padding: 10px;">
    </div>

    <div id="info" style="text-align: center; padding: 30px;"></div>

    <script>
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 3 // 지도의 확대 레벨
            };

        // 지도를 생성합니다    
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();

        var coords = null;

        var place = null;

        var markers = []; // 마커 전체적으로 통제

        var infoWindows = [];    // infoWindow 전체적으로 통제

        var flag = 0; // 주소검색인지 키워드검색인지 구분
        $('#submit').click(function(){

            // 기존의 마커 제거
            if(markers.length!=0){
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
            }

            // 기존의 infoWindow 제거
            if(infoWindows.length!=0){
                for (var i = 0; i < infoWindows.length; i++) {
                    infoWindows[i].close();
                    console.log('dd');
                }
            }

            // 주소로 좌표를 검색합니다
            geocoder.addressSearch($('#address').val(), function (result, status) {

                // 정상적으로 검색이 완료됐으면 
                if (status === kakao.maps.services.Status.OK) {
                    flag = 0;

                    coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    // 추출한 좌표를 통해 도로명 주소 추출
                    let lat = result[0].y;
                    let lng = result[0].x;
                    getAddr(lat,lng);
                    function getAddr(lat,lng){
                        let geocoder = new kakao.maps.services.Geocoder();
        
                        let coord = new kakao.maps.LatLng(lat, lng);
                        let callback = function(result, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                // 추출한 도로명 주소를 해당 input의 value값으로 적용
                                $('#address').val(result[0].road_address.address_name);
                            }
                        }
                        geocoder.coord2Address(coord.getLng(), coord.getLat(), callback);
                    }
                    // 결과값으로 받은 위치를 마커로 표시합니다
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: coords
                    });

                    // 인포윈도우로 장소에 대한 설명을 표시합니다
                    var infowindow = new kakao.maps.InfoWindow({
                        content: '<div id="place" style="width:150px;text-align:center;padding:6px 0;">' + $('#address').val() + '</div>'
                    });
                    marker.setMap(map);
                    markers.push(marker);   // 생성된 마커를 배열에 추가

                    infowindow.open(map, marker);
                    infoWindows.push(infowindow);   // 생성된 infoWindow 배열에 추가

                    // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                    map.setCenter(coords);
                }
                else {

                    flag = 1;
                    // 장소 검색 객체를 생성합니다
                    var ps = new kakao.maps.services.Places();

                    // 키워드로 장소를 검색합니다
                    ps.keywordSearch($('#address').val(), placesSearchCB);

                    // 키워드 검색 완료 시 호출되는 콜백함수 입니다
                    function placesSearchCB(data, status, pagination) {
                        if (status === kakao.maps.services.Status.OK) {

                            place = new kakao.maps.LatLng(data[0].y, data[0].x);

                            // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                            // LatLngBounds 객체에 좌표를 추가합니다
                            var bounds = new kakao.maps.LatLngBounds();

                            displayMarker(data[0]);
                            bounds.extend(new kakao.maps.LatLng(data[0].y, data[0].x));

                            // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                            map.setBounds(bounds);
                        }
                    }

                    // 지도에 마커를 표시하는 함수입니다
                    function displayMarker(place) {

                        // 마커를 생성하고 지도에 표시합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: new kakao.maps.LatLng(place.y, place.x)
                        });

                        // 인포윈도우로 장소에 대한 설명을 표시합니다
                        var infowindow = new kakao.maps.InfoWindow({
                            content: '<div id="place1" style="width:150px; text-align:center; padding:6px 0;">' + place.place_name + '</div>'
                        });
                        marker.setMap(map);
                        markers.push(marker);   // 생성된 마커를 배열에 추가

                        infowindow.open(map, marker);
                        infoWindows.push(infowindow);   // 생성된 infoWindow 배열에 추가

                        // 마커에 클릭이벤트를 등록합니다
                        // kakao.maps.event.addListener(marker, 'click', function () {
                        // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                        //     infowindow.setContent('<div style="padding:5px;font-size:12px;">' + $('#address').val() + '</div>');
                        //     infowindow.open(map, marker);
                        // });
                    }
                }

                document.getElementById('address').value = null;    // 주소 검색 창 리셋
            });
        });

        // 창 크기 조절 중 함수 실행 금지
        var timer = null;
        var delay = 300;

        $(window).resize(function () {
            var mapContainer = document.getElementById('map');
            clearTimeout(timer);
            timer = setTimeout(function () {
                if(flag==0){
                    map.setCenter(coords);
                }
                else if(flag==1){
                    map.setCenter(place);
                }
            }, delay);
        })
    </script>
</body>

</html>